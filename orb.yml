version: 2.1
description: The end-to-end test suite for use in CLA app pipelines

commands:
  behave:
    description: Run the CLA apps in a docker cluster and run the Behave test suite against them
    steps:
      - setup_remote_docker
      - run:
          name: Authenticate with awscli
          command: |
            login="$(aws ecr get-login --region eu-west-2 --no-include-email)"
            ${login}
      - run:
          name: Build / pull Docker images
          command: |
            docker-compose pull
            docker-compose build
      - run:
          name: Check services are up
          command: |
            docker-compose run start_applications
            docker-compose exec clabackend bin/create_db.sh
      - run:
          name: Run behave tests
          command: |
            docker-compose run --name cla-end-to-end cla-end-to-end
      - run:
          name: Copy artifacts
          command: |
            echo "Manually copying files because circleci docker executor does not support volumes"
            echo "https://support.circleci.com/hc/en-us/articles/360007324514-How-can-I-mount-volumes-to-docker-containers-"
            docker cp cla-end-to-end:/data behave/data
          when: always
      - store_artifacts:
          path: behave/data
          destination: data

jobs:
  behave:
    docker:
      - image: "754256621582.dkr.ecr.eu-west-2.amazonaws.com/laa-get-access/laa-cla-end-to-end-tests-ecr:${CLA_E2E_IMAGE_VERSION:-latest}"
    steps:
      - behave