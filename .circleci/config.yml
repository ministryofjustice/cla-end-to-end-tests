version: 2.1
orbs:
  aws-ecr: circleci/aws-ecr@7.3.0
  orb-tools: circleci/orb-tools@10.1.0

jobs:
  behave:
    parameters:
      run_a11y:
        type: boolean
    docker:
      - image: cimg/python:3.10.1
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Run linter and formatting checks
          command: |
            pip install pre-commit==2.17.0
            pre-commit run --all-files
      - run:
          name: Install compatible docker-compose
          command: pip install docker-compose==1.27.4
      - run:
          name: Authenticate with awscli
          command: |
            pip install awscli
            login="$(aws ecr get-login --region eu-west-2 --no-include-email)"
            ${login}
      - run:
          name: Build / pull Docker images
          command: |
            cd behave
            docker-compose pull
            docker-compose build --build-arg a11y="<< parameters.run_a11y >>"
      - run:
          name: Check services are up
          command: |
            cd behave
            docker-compose run start_applications
            docker-compose exec clabackend bin/create_db.sh
      - run:
          name: Run behave tests
          command: |
            cd behave
            docker-compose run --name cla-end-to-end cla-end-to-end
      - run:
          name: Copy artifacts
          command: |
            mkdir -p /tmp/feature_errors
            docker cp cla-end-to-end:behave_local ../../../tmp/feature_errors
          when: always
      - store_artifacts:
          path: /tmp/feature_errors

workflows:
  build:
    jobs:
      - aws-ecr/build-and-push-image:
          name: Build and push
          repo: "${AWS_RESOURCE_NAME_PREFIX}"
          tag: "${CIRCLE_SHA1}"
      - aws-ecr/build-and-push-image:
          name: Build and push latest tag
          repo: "${AWS_RESOURCE_NAME_PREFIX}"
          tag: "latest"
          filters:
            branches:
              only:
                - main
      - orb-tools/publish-dev:
          name: publish_dev_orb
          attach-workspace: false
          checkout: true
          orb-name: ministryofjustice/cla-end-to-end-tests
          orb-path: orb.yml
          context:
            - laa-cla-orbs-token
      - orb-tools/increment:
          name: publish_production_orb
          segment: patch
          orb-ref: ministryofjustice/cla-end-to-end-tests
          orb-path: orb.yml
          requires:
            - publish_dev_orb
          context:
            - laa-cla-orbs-token
          filters:
            branches:
              only:
                - main
      - behave:
          name: behave
          run_a11y: true
